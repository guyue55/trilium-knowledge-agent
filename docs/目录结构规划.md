# æ™ºèƒ½é—®ç­”ç³»ç»Ÿé¡¹ç›®ç›®å½•ç»“æ„è§„åˆ’

åŸºäº FastAPI + LangChain + Trilium Notes é›†æˆæ–¹æ¡ˆï¼Œä»¥ä¸‹æ˜¯æ¨èçš„é¡¹ç›®ç›®å½•ç»“æ„ï¼š

```plaintext
ğŸ“‚ trilium-knowledge-agent/
â”œâ”€â”€ ğŸ“‚ app/# æ ¸å¿ƒåº”ç”¨ä»£ç 
â”‚â”œâ”€â”€ ğŸ“‚ api/# API è·¯ç”±å’Œæ§åˆ¶å™¨
â”‚â”‚â”œâ”€â”€ ğŸ“„ endpoints.py# FastAPI è·¯ç”±å®šä¹‰
â”‚â”‚â””â”€â”€ ğŸ“„ schemas.py# Pydantic è¯·æ±‚/å“åº”æ¨¡å‹
â”‚â”œâ”€â”€ ğŸ“‚ core/# æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚â”‚â”œâ”€â”€ ğŸ“„ config.py# åº”ç”¨é…ç½®ç®¡ç†
â”‚â”‚â”œâ”€â”€ ğŸ“„ trilium_integration.py# Trilium Notes é›†æˆæœåŠ¡
â”‚â”‚â”œâ”€â”€ ğŸ“„ knowledge_base.py# çŸ¥è¯†åº“ç®¡ç†æœåŠ¡
â”‚â”‚â”œâ”€â”€ ğŸ“„ llm_service.py# è¯­è¨€æ¨¡å‹æœåŠ¡
â”‚â”‚â””â”€â”€ ğŸ“„ qa_service.py# é—®ç­”æœåŠ¡æ ¸å¿ƒé€»è¾‘
â”‚â”œâ”€â”€ ğŸ“‚ models/# æ•°æ®æ¨¡å‹
â”‚â”‚â”œâ”€â”€ ğŸ“„ document.py# æ–‡æ¡£æ¨¡å‹
â”‚â”‚â””â”€â”€ ğŸ“„ conversation.py# å¯¹è¯å†å²æ¨¡å‹
â”‚â”œâ”€â”€ ğŸ“‚ utils/# å·¥å…·å‡½æ•°
â”‚â”‚â”œâ”€â”€ ğŸ“„ file_utils.py# æ–‡ä»¶å¤„ç†å·¥å…·
â”‚â”‚â”œâ”€â”€ ğŸ“„ logger.py# æ—¥å¿—é…ç½®
â”‚â”‚â””â”€â”€ ğŸ“„ monitoring.py# ç›‘æ§æŒ‡æ ‡
â”‚â””â”€â”€ ğŸ“„ main.py# FastAPI åº”ç”¨å…¥å£
â”œâ”€â”€ ğŸ“‚ data/# æ•°æ®å­˜å‚¨ç›®å½•
â”‚â”œâ”€â”€ ğŸ“‚ trilium/# Trilium ç›¸å…³æ•°æ®
â”‚â”‚â”œâ”€â”€ ğŸ“‚ cache/# Trilium æ•°æ®ç¼“å­˜
â”‚â”‚â””â”€â”€ ğŸ“„ trilium_config.json# Trilium è¿æ¥é…ç½®
â”‚â”œâ”€â”€ ğŸ“‚ vector_db/# å‘é‡æ•°æ®åº“å­˜å‚¨
â”‚â”‚â”œâ”€â”€ ğŸ“„ embeddings/# åµŒå…¥å‘é‡å­˜å‚¨
â”‚â”‚â””â”€â”€ ğŸ“„ chroma_config.json# ChromaDB é…ç½®
â”‚â””â”€â”€ ğŸ“‚ models/# æœ¬åœ°æ¨¡å‹æ–‡ä»¶
â”‚â”œâ”€â”€ ğŸ“„ gpt4all/# GPT4All æ¨¡å‹
â”‚â””â”€â”€ ğŸ“„ sentence-transformers/# åµŒå…¥æ¨¡å‹
â”œâ”€â”€ ğŸ“‚ scripts/# å®ç”¨è„šæœ¬
â”‚â”œâ”€â”€ ğŸ“„ setup_trilium.py# Trilium åˆå§‹åŒ–è„šæœ¬
â”‚â”œâ”€â”€ ğŸ“„ update_knowledge_base.py# çŸ¥è¯†åº“æ›´æ–°è„šæœ¬
â”‚â”œâ”€â”€ ğŸ“„ benchmark.py# æ€§èƒ½æµ‹è¯•è„šæœ¬
â”‚â””â”€â”€ ğŸ“„ monitor.py# ç³»ç»Ÿç›‘æ§è„šæœ¬
â”œâ”€â”€ ğŸ“‚ tests/# æµ‹è¯•ç›®å½•
â”‚â”œâ”€â”€ ğŸ“„ test_api.py# API æµ‹è¯•
â”‚â”œâ”€â”€ ğŸ“„ test_core.py# æ ¸å¿ƒé€»è¾‘æµ‹è¯•
â”‚â””â”€â”€ ğŸ“„ test_utils.py# å·¥å…·å‡½æ•°æµ‹è¯•
â”œâ”€â”€ ğŸ“‚ frontend/# å‰ç«¯ç•Œé¢ (å¯é€‰)
â”‚â”œâ”€â”€ ğŸ“‚ public/
â”‚â”œâ”€â”€ ğŸ“‚ src/
â”‚â”œâ”€â”€ ğŸ“„ package.json
â”‚â””â”€â”€ ğŸ“„ Dockerfile
â”œâ”€â”€ ğŸ“‚ docker/# Docker é…ç½®
â”‚â”œâ”€â”€ ğŸ“„ Dockerfile# ä¸»åº”ç”¨é•œåƒ
â”‚â”œâ”€â”€ ğŸ“„ docker-compose.yml# å¤šå®¹å™¨ç¼–æ’
â”‚â””â”€â”€ ğŸ“„ nginx.conf# Nginx é…ç½®
â”œâ”€â”€ ğŸ“„ requirements.txt# Python ä¾èµ–
â”œâ”€â”€ ğŸ“„ .env.example# ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ ğŸ“„ .gitignore# Git å¿½ç•¥é…ç½®
â”œâ”€â”€ ğŸ“„ Makefile# å¸¸ç”¨å‘½ä»¤å¿«æ·æ–¹å¼
â”œâ”€â”€ ğŸ“„ README.md# é¡¹ç›®æ–‡æ¡£
â””â”€â”€ ğŸ“„ pyproject.toml# Python é¡¹ç›®é…ç½®
```

## å…³é”®ç›®å½•è¯¦ç»†è¯´æ˜

### 1. `app/` - æ ¸å¿ƒåº”ç”¨ä»£ç 
- **api/**ï¼šAPI è·¯ç”±å±‚ï¼Œå¤„ç† HTTP è¯·æ±‚å’Œå“åº”
- **core/**ï¼šä¸šåŠ¡é€»è¾‘æ ¸å¿ƒï¼ŒåŒ…å« Trilium é›†æˆã€çŸ¥è¯†åº“ç®¡ç†ã€é—®ç­”æœåŠ¡
- **models/**ï¼šæ•°æ®æ¨¡å‹å®šä¹‰
- **utils/**ï¼šé€šç”¨å·¥å…·å‡½æ•°å’Œè¾…åŠ©ç±»

### 2. `data/` - æ•°æ®å­˜å‚¨
- **trilium/**ï¼šTrilium Notes ç›¸å…³æ•°æ®å’Œé…ç½®
- **vector_db/**ï¼šå‘é‡æ•°æ®åº“å­˜å‚¨ï¼ˆChromaDBï¼‰
- **models/**ï¼šæœ¬åœ°è¯­è¨€æ¨¡å‹æ–‡ä»¶

### 3. `scripts/` - å®ç”¨è„šæœ¬
- **setup_trilium.py**ï¼šåˆå§‹åŒ– Trilium è¿æ¥å’Œé…ç½®
- **update_knowledge_base.py**ï¼šå¢é‡æ›´æ–°çŸ¥è¯†åº“å‘é‡å­˜å‚¨
- **benchmark.py**ï¼šç³»ç»Ÿæ€§èƒ½æµ‹è¯•å·¥å…·

### 4. `docker/` - å®¹å™¨åŒ–é…ç½®
- **Dockerfile**ï¼šä¸»åº”ç”¨å®¹å™¨æ„å»ºæ–‡ä»¶
- **docker-compose.yml**ï¼šå¤šæœåŠ¡ç¼–æ’é…ç½®
- **nginx.conf**ï¼šåå‘ä»£ç†é…ç½®

## å…³é”®æ–‡ä»¶è¯´æ˜

### `app/core/trilium_integration.py`
```python
from langchain.document_loaders import TriliumLoader
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

class TriliumService:
def __init__(self, config):
self.base_url = config.trilium_base_url
self.token = config.trilium_token
self.note_ids = config.note_ids
self.data_dir = config.trilium_data_dir

# åˆå§‹åŒ–çŸ¥è¯†åº“åŠ è½½å™¨
self.loader = TriliumLoader(
base_url=self.base_url,
token=self.token,
note_ids=self.note_ids
)

# è®¾ç½®æ–‡ä»¶ç³»ç»Ÿç›‘æ§
self.event_handler = TriliumChangeHandler(self)
self.observer = Observer()
self.observer.schedule(
self.event_handler,
path=self.data_dir,
recursive=True
)
self.observer.start()

def load_documents(self):
"""åŠ è½½ Trilium æ–‡æ¡£"""
return self.loader.load()

def get_note_content(self, note_id):
"""è·å–ç‰¹å®šç¬”è®°å†…å®¹"""
# å®ç°ç»†èŠ‚...

class TriliumChangeHandler(FileSystemEventHandler):
def __init__(self, service):
self.service = service

def on_modified(self, event):
if "notes" in event.src_path:
print(f"æ£€æµ‹åˆ°çŸ¥è¯†åº“æ›´æ–°: {event.src_path}")
# è§¦å‘çŸ¥è¯†åº“æ›´æ–°å¤„ç†
self.service.update_knowledge_base()
```

### `app/core/knowledge_base.py`
```python
from langchain.embeddings import HuggingFaceEmbeddings
from langchain.vectorstores import Chroma
from langchain.text_splitter import RecursiveCharacterTextSplitter

class KnowledgeBase:
def __init__(self, config):
self.embedding_model = HuggingFaceEmbeddings(
model_name=config.embedding_model
)
self.vector_store = Chroma(
embedding_function=self.embedding_model,
persist_directory=config.vector_db_dir
)
self.text_splitter = RecursiveCharacterTextSplitter(
chunk_size=1000,
chunk_overlap=200
)

def update_vector_store(self, documents):
"""æ›´æ–°å‘é‡æ•°æ®åº“"""
# åˆ†å‰²æ–‡æ¡£
texts = self.text_splitter.split_documents(documents)

# æ›´æ–°å‘é‡æ•°æ®åº“
self.vector_store.add_documents(texts)
self.vector_store.persist()

def semantic_search(self, query, k=5):
"""è¯­ä¹‰æœç´¢ç›¸å…³æ–‡æ¡£"""
return self.vector_store.similarity_search(query, k=k)
```

### `app/core/qa_service.py`
```python
from langchain.chains import RetrievalQA
from langchain.chains.conversation.memory import ConversationBufferMemory

class QAService:
def __init__(self, config, llm_service, knowledge_base):
self.llm = llm_service.get_llm()
self.knowledge_base = knowledge_base
self.memory = ConversationBufferMemory(
memory_key="chat_history",
return_messages=True
)

# åˆ›å»ºæ£€ç´¢å¢å¼ºçš„é—®ç­”é“¾
self.qa_chain = RetrievalQA.from_chain_type(
llm=self.llm,
chain_type="stuff",
retriever=self.knowledge_base.vector_store.as_retriever(),
memory=self.memory,
return_source_documents=True
)

def ask_question(self, question):
"""å›ç­”ç”¨æˆ·é—®é¢˜"""
result = self.qa_chain({"query": question})
return {
"answer": result["result"],
"sources": self._format_sources(result["source_documents"])
}

def _format_sources(self, documents):
"""æ ¼å¼åŒ–æ¥æºæ–‡æ¡£ä¿¡æ¯"""
return [
{
"source": doc.metadata["source"],
"content": doc.page_content[:500] + "..."
}
for doc in documents
]
```

### `app/api/endpoints.py`
```python
from fastapi import APIRouter, Depends
from app.core.config import get_config
from app.core.qa_service import get_qa_service
from app.api.schemas import QuestionRequest, AnswerResponse

router = APIRouter()

@router.post("/ask", response_model=AnswerResponse)
async def ask_question(
request: QuestionRequest,
qa_service=Depends(get_qa_service)
):
"""é—®ç­”APIç«¯ç‚¹"""
response = qa_service.ask_question(request.question)
return {
"answer": response["answer"],
"sources": response["sources"]
}
```

## éƒ¨ç½²ä¸è¿è¡Œè¯´æ˜

### å¿«é€Ÿå¯åŠ¨
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/yourname/trilium-knowledge-agent.git
cd trilium-knowledge-agent

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½® Trilium å‡­æ®ç­‰

# åˆå§‹åŒ–çŸ¥è¯†åº“
python scripts/setup_trilium.py

# å¯åŠ¨æœåŠ¡
uvicorn app.main:app --reload --port 8000
```

### Docker éƒ¨ç½²
```bash
docker-compose up -d --build
```

è¿™ä¸ªç›®å½•ç»“æ„è®¾è®¡è€ƒè™‘äº†ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
1. **æ¨¡å—åŒ–**ï¼šåŠŸèƒ½åˆ†ç¦»æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
2. **å¯é…ç½®æ€§**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ç®¡ç†ä¸åŒç¯å¢ƒ
3. **å¯æµ‹è¯•æ€§**ï¼šç‹¬ç«‹çš„æµ‹è¯•ç›®å½•å’Œæµ‹è¯•å·¥å…·
4. **å¯æ‰©å±•æ€§**ï¼šé¢„ç•™äº†å‰ç«¯å’Œç›‘æ§çš„æ‰©å±•ç©ºé—´
5. **å®¹å™¨åŒ–æ”¯æŒ**ï¼šå®Œæ•´çš„ Docker æ”¯æŒ

è¿™æ ·çš„ç»“æ„æ—¢é€‚åˆå¿«é€ŸåŸå‹å¼€å‘ï¼Œä¹Ÿèƒ½æ»¡è¶³ç”Ÿäº§ç¯å¢ƒéœ€æ±‚ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„ä»£ç ç»„ç»‡æ€§ã€‚